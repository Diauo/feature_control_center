<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>业务管理</title>
    <script src="[| url_for('static', filename='js/lib/vue.global.min.js') |]"></script>
    <script src="[| url_for('static', filename='js/lib/axios.min.js') |]"></script>
    <link rel="stylesheet" href="[| url_for('static', filename='css/index.css') |]">
</head>
<body>
    <div id="app">
        <nav class="nav">
            <div class="nav-container">
                <div class="nav-links">
                    <a href="/" class="nav-link">返回主页</a>
                </div>
                <div class="user-info" v-if="currentUser">
                    <span>欢迎, {{ currentUser.username }}!</span>
                    <button class="btn-logout" @click="logout">登出</button>
                </div>
            </div>
        </nav>

        <div class="content">
            <!-- 页面切换 -->
            <div class="sub-nav">
                <a href="#" @click="currentPage = 'users'" :class="{ 'active': currentPage === 'users' }">用户管理</a>
                <a href="#" @click="currentPage = 'customers'" :class="{ 'active': currentPage === 'customers' }">客户管理</a>
            </div>

            <!-- 用户管理 -->
            <div v-if="currentPage === 'users'">
                <h2>用户管理</h2>
                <div class="table-actions">
                    <button class="btn-primary" @click="openUserModal(null, $event)">新增用户</button>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>用户名</th>
                            <th>邮箱</th>
                            <th>角色</th>
                            <th>关联客户</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="user in users" :key="user.id">
                            <td>{{ user.id }}</td>
                            <td>{{ user.username }}</td>
                            <td>{{ user.email }}</td>
                            <td>{{ user.role }}</td>
                            <td>{{ user.customers && user.customers.length > 0 ? user.customers.map(c => c.name).join(', ') : '无' }}</td>
                            <td>
                                <button class="btn-edit" @click="openUserModal(user, $event)">编辑</button>
                                <button class="btn-danger" @click="deleteUser(user.id)">删除</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 客户管理 -->
            <div v-if="currentPage === 'customers'">
                <h2>客户管理</h2>
                <div class="table-actions">
                    <button class="btn-primary" @click="openCustomerModal(null, $event)">新增客户</button>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>客户名称</th>
                            <th>描述</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="customer in customers" :key="customer.id">
                            <td>{{ customer.id }}</td>
                            <td>{{ customer.name }}</td>
                            <td>{{ customer.description }}</td>
                            <td>
                                <button class="btn-edit" @click="openCustomerModal(customer, $event)">编辑</button>
                                <button class="btn-danger" @click="deleteCustomer(customer.id)">删除</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 通用模态框 -->
        <div class="modal-overlay" v-bind:class="{ active: modal.show }" @click="closeModal()"></div>
        <div class="modal" ref="modalWindow" v-bind:class="{ active: modal.show }" :style="{
            top: modal.top + 'px',
            left: modal.left + 'px'
          }">
            <h1>{{ modal.title }}</h1>
            <hr class="modal-line">
            <h4 v-html="modal.description"></h4>
            <hr class="modal-line">
            <!-- 动态渲染输入框 -->
            <div v-for="(field, index) in modal.fields" :key="index">
                <label :id="'modal-label-'+index" class="modal-label">{{ field.label }}:</label>
                <input :id="'modal-input-'+index" class="modal-input" v-if="field.type === 'text'" type="text"
                    v-model="modal.modalParams[field.key]" :placeholder="'请输入' + field.label">
                <input :id="'modal-input-'+index" class="modal-input" v-if="field.type === 'password'" type="password"
                    v-model="modal.modalParams[field.key]" :placeholder="field.placeholder">
                <textarea :id="'modal-textarea-'+index" class="modal-input" v-else-if="field.type === 'textarea'"
                    v-model="modal.modalParams[field.key]" :placeholder="'请输入' + field.label"></textarea>
                <select :id="'modal-select-'+index" class="modal-input" v-else-if="field.type === 'select'" v-model="modal.modalParams[field.key]">
                    <option v-for="(option, i) in field.options" :key="i" :value="option.value">{{ option.text }}</option>
                </select>
                <select :id="'modal-multiselect-'+index" class="modal-input" v-else-if="field.type === 'multiselect'" v-model="modal.modalParams[field.key]" multiple>
                    <option v-for="(option, i) in field.options" :key="i" :value="option.value">{{ option.text }}</option>
                </select>
            </div>
            <hr class="modal-line">
            <div style="display: flex;">
                <div v-for="(button, index) in modal.buttons" :key="index">
                    <button :id="'modal-button-'+index" :class="button.style" @click="button.function(button.param)">
                        {{ button.label }} </button>
                </div>
                <button id="modal-button-cancel" class="btn-cancel" @click="closeModal">取消</button>
            </div>
        </div>
    </div>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script type="module" src="[| url_for('static', filename='js/admin.js') |]"></script>
</body>
</html>